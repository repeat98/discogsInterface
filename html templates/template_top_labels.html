<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Top-Rated Techno Vinyl Labels of All Time (Discogs)</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      /* ===== Global reset & typography ===== */
      html,
      body {
        margin: 0;
        padding: 0;
        background-color: #F1F1F1;
        font-family: Inter, "Segoe UI", sans-serif;
        color: #414651;
      }

      /* ===== Page container ===== */
      .Desktop {
        position: relative;
        min-height: 100vh;
        background: #F1F1F1;
      }

      .MainContainer {
        margin: 0 auto;
        max-width: 1400px;
        padding-top: 60px;
        padding-bottom: 60px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* ===== Navbar styling ===== */
      .navbar {
        background-color: #1a202c !important;
      }
      .navbar-brand {
        display: flex;
        align-items: center;
      }
      .navbar-brand i {
        margin-right: 8px;
      }

      /* ===== Header (h1, etc.) ===== */
      .header-title {
        font-size: 29px;
        font-weight: 400;
        line-height: 1.2;
        margin: 0;
      }

      /* ===== Filter Container ===== */
      .FilterContainer {
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        padding: 16px;
      }
      .filter-group {
        position: relative;
        flex: 1;
        min-width: 150px;
      }
      .filter-label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 4px;
        color: #414651;
      }
      .filter-input,
      .filter-select {
        width: 100%;
        background: #fff;
        box-shadow: 0px 1px 2px rgba(10, 12.67, 18, 0.05);
        border: 1px solid #D5D7DA;
        border-radius: 8px;
        font-size: 12px;
        color: #717680;
        padding: 8px 10px;
      }
      .filter-input::placeholder {
        color: #717680;
      }
      .filter-button {
        flex: 1;
        min-width: 150px;
        align-self: flex-end;
        height: 40px;
      }

      /* ===== Table styling ===== */
      .table-container {
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      thead th {
        background: #414651 !important;
        color: #ffffff !important;
        font-weight: 700;
        font-size: 14px;
        white-space: nowrap;
      }
      tbody tr {
        border-bottom: 1px solid #D7D7D7;
      }
      tbody td {
        vertical-align: middle;
        font-size: 12px;
        padding: 16px;
      }
      tbody tr:hover {
        background-color: #f7f7f7;
      }

      /* ===== No results styling ===== */
      .no-results {
        text-align: center;
        padding: 2rem 0;
        color: #718096;
      }
      .no-results i {
        font-size: 2rem;
        margin-bottom: 1rem;
      }

      /* ===== Badge styling (Genre / Style) ===== */
      .badge-genre,
      .badge-style {
        border-radius: 16px;
        padding: 2px 8px;
        font-size: 12px;
        display: inline-block;
        white-space: nowrap;
        margin: 4px 4px 0 0;
      }
      .badge-genre {
        background: #8F89E5;
        color: #fff;
      }
      .badge-style {
        background: #F4F3FF;
        color: #5925DC;
      }

      /* ===== Pagination styling ===== */
      .pagination {
        justify-content: center;
        margin-top: 16px;
      }
      .page-item.active .page-link {
        background-color: #414651 !important;
        border-color: #414651 !important;
      }

      /* ===== Footer ===== */
      footer {
        text-align: center;
        padding: 1rem 0;
      }
      footer small {
        color: #718096;
      }

      /* ===== Releases section styling ===== */
      #releases-section h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      /* Make YouTube embeds consistent with the design */
      iframe.table-iframe {
        border: 0;
        width: 220px;
        height: 124px;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <div class="Desktop">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <i class="bi bi-stars"></i>
            Top-Rated Techno Vinyl Labels of All Time (Discogs)
          </a>
        </div>
      </nav>

      <!-- Main Container -->
      <div class="MainContainer container-fluid">
        <!-- Page Title -->
        <h1 class="header-title mb-4">
          Top-Rated Techno Vinyl Labels of All Time (Discogs)
        </h1>

        <!-- Filter Form -->
        <form id="filter-form" class="FilterContainer">
          <!-- Search Input (Label / Release Title) -->
          <div class="filter-group">
            <label for="search_query" class="filter-label">Search</label>
            <input
              type="text"
              id="search_query"
              name="search_query"
              class="filter-input"
              placeholder="Search by Label or Release Title..."
              aria-label="Search by Label or Release Title"
            />
          </div>

          <!-- Genre Filter -->
          <div class="filter-group">
            <label for="genre" class="filter-label">Genre</label>
            <select
              id="genre"
              name="genre"
              class="filter-select"
              aria-label="Filter by Genre"
            >
              <option value="">All Genres</option>
            </select>
          </div>

          <!-- Style Filter -->
          <div class="filter-group">
            <label for="style" class="filter-label">Style</label>
            <select
              id="style"
              name="style"
              class="filter-select"
              aria-label="Filter by Style"
            >
              <option value="">All Styles</option>
            </select>
          </div>

          <!-- Year ≥ -->
          <div class="filter-group">
            <label for="year_min" class="filter-label">Year ≥</label>
            <input
              type="number"
              id="year_min"
              name="year_min"
              class="filter-input"
              placeholder="e.g. 1995"
              aria-label="Minimum Year"
            />
          </div>

          <!-- Year ≤ -->
          <div class="filter-group">
            <label for="year_max" class="filter-label">Year ≤</label>
            <input
              type="number"
              id="year_max"
              name="year_max"
              class="filter-input"
              placeholder="e.g. 2000"
              aria-label="Maximum Year"
            />
          </div>

          <!-- Filter Button -->
          <div class="filter-button">
            <button type="submit" class="btn btn-primary w-100 h-100">
              <i class="bi bi-funnel-fill"></i> Filter
            </button>
          </div>
        </form>

        <!-- Top Labels Table -->
        <div class="table-container" id="labels-container">
          <table class="table table-hover table-bordered mb-0" id="labels-table">
            <thead>
              <tr>
                <th style="width: 80px;">Rank</th>
                <th>Label</th>
                <th style="width: 150px;"># of Releases</th>
                <th style="width: 160px;">Avg Rating Coeff</th>
                <th style="width: 160px;">Bayesian Score</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls for Labels -->
        <nav class="mt-4" aria-label="Page navigation">
          <ul class="pagination" id="labels-pagination"></ul>
        </nav>

        <hr class="my-5" />

        <!-- Label Releases Section -->
        <div id="releases-section" style="display: none;">
          <h2 id="releases-title" class="mb-4"></h2>
          <div class="table-container">
            <table class="table table-hover table-bordered mb-0" id="releases-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th style="width: 160px;">Label</th>
                  <th style="width: 80px;" class="text-center">Year</th>
                  <th>Genre / Style</th>
                  <th style="width: 150px;" class="text-center">User Rating</th>
                  <th style="width: 100px;" class="text-center">Rarity</th>
                  <th style="width: 100px;" class="text-center">Gem⟡</th>
                  <th style="width: 70px;" class="text-center">Have</th>
                  <th style="width: 70px;" class="text-center">Want</th>
                  <th style="width: 220px;" class="text-center">Preview</th>
                </tr>
              </thead>
              <tbody>
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer>
        <small>&copy; 2025 - Jannik Aßfalg</small>
      </footer>
    </div>

    <!-- Bootstrap JS (with Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Example Data (Adapt to your real data) -->
    <script>
      // Example: Replace this with your actual releases data
      const releasesData = [
        {
          "average_rating": 5.0,
          "country": "Mexico",
          "demand_coeff": 0.75,
          "gem_value": 2.3863636363636362,
          "genre": "Electronic",
          "have": 3,
          "id": 1,
          "label": "RCA", // Key aggregator for the label
          "link": "https://www.discogs.com/release/16875240",
          "lowest_price": 14.33,
          "rating_coeff": 3.1818181818181817,
          "rating_count": 1,
          "style": "Techno",
          "title": "India (2) - India - Stay With Me (Special Remix) Disco-Tec Sencillo = Quédate Conmigo",
          "want": 3,
          "year": "1983",
          "youtube_links": "https://www.youtube.com/watch?v=96XKde8YHk8"
        }
        // Add more releases here...
      ];

      // Bayesian Ranking Parameters
      const BAYESIAN_M = 5; // Minimum # of releases factor for the Bayesian formula

      // Will store the aggregated labels data after filtering
      let labelsData = [];

      // For pagination
      let currentPage = 1;
      const LABELS_PER_PAGE = 10;

      // ---- Utility: Extract YouTube ID from a URL
      function extractYouTubeID(url) {
        const regex =
          /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?/\s]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
      }

      // ---- Build Genre/Style sets for the entire dataset
      const allGenres = new Set();
      const allStyles = new Set();

      releasesData.forEach((release) => {
        // accumulate genres
        if (release.genre) {
          release.genre.split(",").forEach((g) => {
            const trimmed = g.trim();
            if (trimmed) allGenres.add(trimmed);
          });
        }
        // accumulate styles
        if (release.style) {
          release.style.split(",").forEach((s) => {
            const trimmed = s.trim();
            if (trimmed) allStyles.add(trimmed);
          });
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        initFilterDropdowns();
        applyFilters();

        const filterForm = document.getElementById("filter-form");
        filterForm.addEventListener("submit", (e) => {
          e.preventDefault();
          currentPage = 1;
          applyFilters();
        });
      });

      // Populate the Genre/Style dropdowns
      function initFilterDropdowns() {
        const genreSelect = document.getElementById("genre");
        const styleSelect = document.getElementById("style");

        const sortedGenres = [...allGenres].sort();
        const sortedStyles = [...allStyles].sort();

        sortedGenres.forEach((g) => {
          const option = document.createElement("option");
          option.value = g;
          option.textContent = g;
          genreSelect.appendChild(option);
        });

        sortedStyles.forEach((s) => {
          const option = document.createElement("option");
          option.value = s;
          option.textContent = s;
          styleSelect.appendChild(option);
        });
      }

      // Core filtering function
      function applyFilters() {
        const searchQuery = document
          .getElementById("search_query")
          .value.toLowerCase()
          .trim();
        const selectedGenre = document.getElementById("genre").value;
        const selectedStyle = document.getElementById("style").value;
        const yearMin = parseInt(document.getElementById("year_min").value) || -Infinity;
        const yearMax = parseInt(document.getElementById("year_max").value) || Infinity;

        // Filter releases
        const filteredReleases = releasesData.filter((release) => {
          // Year filter
          const rYear = parseInt(release.year) || 0;
          if (rYear < yearMin || rYear > yearMax) return false;

          // Genre filter
          if (selectedGenre) {
            const releaseGenres = release.genre
              ? release.genre.split(",").map((g) => g.trim())
              : [];
            if (!releaseGenres.includes(selectedGenre)) {
              return false;
            }
          }

          // Style filter
          if (selectedStyle) {
            const releaseStyles = release.style
              ? release.style.split(",").map((s) => s.trim())
              : [];
            if (!releaseStyles.includes(selectedStyle)) {
              return false;
            }
          }

          // Search filter (label or title)
          if (searchQuery) {
            const labelLower = (release.label || "").toLowerCase();
            const titleLower = (release.title || "").toLowerCase();
            if (!labelLower.includes(searchQuery) && !titleLower.includes(searchQuery)) {
              return false;
            }
          }

          return true;
        });

        // Re-aggregate labels from the filtered releases
        labelsData = aggregateLabelsData(filteredReleases);
        // Sort by Bayesian score descending
        labelsData.sort((a, b) => b.bayesianScore - a.bayesianScore);

        populateLabelsTable(currentPage);
      }

      // Aggregate label data
      function aggregateLabelsData(releasesSubset) {
        let totalRatingAll = 0;
        let totalCountAll = 0;
        const labelMap = {};

        releasesSubset.forEach((rel) => {
          const labelName = rel.label || "Unknown Label";
          const ratingCoeff = parseFloat(rel.rating_coeff) || 0;

          totalRatingAll += ratingCoeff;
          totalCountAll += 1;

          if (!labelMap[labelName]) {
            labelMap[labelName] = {
              totalRatingCoeff: 0,
              count: 0,
              releases: []
            };
          }
          labelMap[labelName].totalRatingCoeff += ratingCoeff;
          labelMap[labelName].count += 1;
          labelMap[labelName].releases.push(rel);
        });

        const globalAverage = totalCountAll > 0 ? totalRatingAll / totalCountAll : 0;

        return Object.entries(labelMap).map(([labelName, data]) => {
          const avgRatingCoeff =
            data.count > 0 ? data.totalRatingCoeff / data.count : 0;
          // Bayesian formula
          const bayesianScore =
            (BAYESIAN_M * globalAverage + data.totalRatingCoeff) /
            (BAYESIAN_M + data.count);

          return {
            label: labelName,
            averageRatingCoeff: avgRatingCoeff,
            count: data.count,
            bayesianScore: bayesianScore,
            releases: data.releases
          };
        });
      }

      // Populate the Labels table with pagination
      function populateLabelsTable(page) {
        const tbody = document.querySelector("#labels-table tbody");
        tbody.innerHTML = "";

        const totalLabels = labelsData.length;
        const totalPages = Math.ceil(totalLabels / LABELS_PER_PAGE);
        const startIndex = (page - 1) * LABELS_PER_PAGE;
        const endIndex = Math.min(startIndex + LABELS_PER_PAGE, totalLabels);

        if (totalLabels === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="no-results">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <p>No Labels Found</p>
              </td>
            </tr>
          `;
          updatePaginationControls(page, totalPages);
          return;
        }

        let rowsHTML = "";
        for (let i = startIndex; i < endIndex; i++) {
          const labelItem = labelsData[i];
          rowsHTML += `
            <tr>
              <td class="text-center">${i + 1}</td>
              <td
                class="text-primary fw-semibold"
                style="cursor: pointer;"
                data-label-index="${i}"
              >
                ${labelItem.label}
              </td>
              <td class="text-center">${labelItem.count}</td>
              <td class="text-center">${labelItem.averageRatingCoeff.toFixed(3)}</td>
              <td class="text-center">${labelItem.bayesianScore.toFixed(3)}</td>
            </tr>
          `;
        }

        tbody.innerHTML = rowsHTML;

        // Handle row clicks
        tbody.removeEventListener("click", handleLabelClick);
        tbody.addEventListener("click", handleLabelClick);

        // Update pagination
        updatePaginationControls(page, totalPages);
      }

      // Label row click => show releases
      function handleLabelClick(e) {
        const target = e.target.closest("[data-label-index]");
        if (!target) return;
        const labelIndex = parseInt(target.getAttribute("data-label-index"), 10);
        const selectedLabel = labelsData[labelIndex];
        showLabelReleases(selectedLabel);
      }

      // Update pagination controls
      function updatePaginationControls(page, totalPages) {
        const pagination = document.getElementById("labels-pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        // Prev
        const prevLi = document.createElement("li");
        prevLi.classList.add("page-item");
        if (page === 1) prevLi.classList.add("disabled");
        const prevLink = document.createElement("a");
        prevLink.classList.add("page-link");
        prevLink.href = "#";
        prevLink.innerHTML = `<i class="bi bi-chevron-left"></i> Prev`;
        prevLink.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            populateLabelsTable(currentPage);
          }
        });
        prevLi.appendChild(prevLink);
        pagination.appendChild(prevLi);

        // Range
        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(totalPages, page + 2);
        if (page <= 3) endPage = Math.min(5, totalPages);
        if (page >= totalPages - 2) startPage = Math.max(1, totalPages - 4);

        for (let i = startPage; i <= endPage; i++) {
          const pageLi = document.createElement("li");
          pageLi.classList.add("page-item");
          if (i === page) pageLi.classList.add("active");
          const pageLink = document.createElement("a");
          pageLink.classList.add("page-link");
          pageLink.href = "#";
          pageLink.textContent = i;
          pageLink.addEventListener("click", (ev) => {
            ev.preventDefault();
            currentPage = i;
            populateLabelsTable(currentPage);
          });
          pageLi.appendChild(pageLink);
          pagination.appendChild(pageLi);
        }

        // Next
        const nextLi = document.createElement("li");
        nextLi.classList.add("page-item");
        if (page === totalPages) nextLi.classList.add("disabled");
        const nextLink = document.createElement("a");
        nextLink.classList.add("page-link");
        nextLink.href = "#";
        nextLink.innerHTML = `Next <i class="bi bi-chevron-right"></i>`;
        nextLink.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            populateLabelsTable(currentPage);
          }
        });
        nextLi.appendChild(nextLink);
        pagination.appendChild(nextLi);
      }

      // Show releases of the selected label
      function showLabelReleases(labelData) {
        const releasesSection = document.getElementById("releases-section");
        const releasesTitle = document.getElementById("releases-title");
        const releasesTbody = document.querySelector("#releases-table tbody");

        releasesSection.style.display = "block";
        releasesTitle.textContent = `Releases on Label: "${labelData.label}"`;
        releasesTbody.innerHTML = "";

        if (labelData.releases.length === 0) {
          releasesTbody.innerHTML = `
            <tr>
              <td colspan="10" class="no-results">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <p>No releases found for this label.</p>
              </td>
            </tr>
          `;
          return;
        }

        let rowsHTML = "";
        labelData.releases.forEach((rel) => {
          const splittedGenres = (rel.genre || "Unknown")
            .split(",")
            .map(g => g.trim())
            .filter(Boolean);
          const splittedStyles = (rel.style || "Unknown")
            .split(",")
            .map(s => s.trim())
            .filter(Boolean);

          const genreBadges = splittedGenres
            .map(g => `<span class="badge-genre">${g}</span>`)
            .join("");
          const styleBadges = splittedStyles
            .map(s => `<span class="badge-style">${s}</span>`)
            .join("");

          const ratingCoeff = rel.rating_coeff
            ? parseFloat(rel.rating_coeff).toFixed(2)
            : "0.00";
          const ratingCount = rel.rating_count || 0;
          const demandCoeff = rel.demand_coeff
            ? rel.demand_coeff.toFixed(2)
            : "0.00";
          const gemValue = rel.gem_value
            ? rel.gem_value.toFixed(2)
            : "0.00";
          const have = rel.have || 0;
          const want = rel.want || 0;

          // YouTube preview
          let previewHTML = `<span class="text-muted">No links</span>`;
          if (rel.youtube_links) {
            const links = rel.youtube_links
              .split(",")
              .map(l => l.trim())
              .filter(l => l);
            if (links.length > 0) {
              const youtubeID = extractYouTubeID(links[0]);
              if (youtubeID) {
                previewHTML = `
                  <iframe
                    class="table-iframe"
                    loading="lazy"
                    title="YouTube video player"
                    aria-label="YouTube video player"
                    src="https://www.youtube.com/embed/${youtubeID}?rel=0&modestbranding=1"
                    frameborder="0"
                    allowfullscreen
                  ></iframe>
                `;
              } else {
                previewHTML = `<span class="text-muted">Invalid link</span>`;
              }
            }
          }

          rowsHTML += `
            <tr>
              <td>
                <a
                  href="${rel.link}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-primary fw-semibold text-decoration-none"
                >
                  ${rel.title}
                </a>
              </td>
              <td>${rel.label || "Unknown"}</td>
              <td class="text-center">${rel.year || ""}</td>
              <td>${genreBadges}${styleBadges}</td>
              <td class="text-center">
                ${ratingCoeff} (${ratingCount})
              </td>
              <td class="text-center">${demandCoeff}</td>
              <td class="text-center">${gemValue}</td>
              <td class="text-center">${have}</td>
              <td class="text-center">${want}</td>
              <td class="text-center">${previewHTML}</td>
            </tr>
          `;
        });

        releasesTbody.innerHTML = rowsHTML;
      }
    </script>
  </body>
</html>