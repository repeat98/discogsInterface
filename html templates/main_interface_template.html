<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Discogs Releases</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      /* ===== Global Body Styling ===== */
      body {
        background-color: #f4f6f9;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        margin: 0;
        padding: 0;
        transition: background-color 0.3s, color 0.3s;
      }

      /* ===== Navbar Styling ===== */
      .navbar {
        background-color: #1a202c;
        box-shadow: 0 4px 6px -6px #222;
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: 1px;
        color: #fff !important;
        display: flex;
        align-items: center;
      }

      .navbar-brand i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
      }

      /* ===== Header Styling ===== */
      header {
        text-align: center;
        padding: 3rem 0 2rem 0;
      }

      header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: #1a202c;
        transition: color 0.3s;
      }

      header p {
        font-size: 1.1rem;
        color: #6c757d;
        transition: color 0.3s;
      }

      /* ===== Filter/Search Form ===== */
      .filter-form {
        background-color: #ffffff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 3rem;
        margin-left: auto;
        margin-right: auto;
        transition: background-color 0.3s, color 0.3s;
      }

      .filter-form .form-label {
        font-weight: 600;
      }

      /* ===== Table Container & Responsive ===== */
      .table-container {
        max-width: 100%;
        margin-left: auto;
        margin-right: auto;
      }

      .table-responsive {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        background-color: #ffffff;
        transition: background-color 0.3s, color 0.3s;
      }

      /* ===== Table & THead ===== */
      table {
        min-width: 100%;
        table-layout: fixed;
      }

      th {
        background-color: #2d3748;
        color: #ffffff;
        position: sticky;
        top: 0;
        z-index: 1;
        font-weight: 600;
        cursor: pointer;
        position: relative; /* For resizer positioning */
        transition: background-color 0.3s, color 0.3s;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      td {
        overflow: hidden;
        text-overflow: ellipsis;
        
      }

      th a {
        color: #ffffff;
        text-decoration: none;
      }

      th a:hover {
        text-decoration: underline;
      }

      .sort-indicator {
        font-size: 0.75rem;
        margin-left: 4px;
      }

      /* ===== Table Body, Hover, and Striped ===== */
      tbody tr:nth-child(odd) {
        background-color: #f9fafb;
        transition: background-color 0.3s;
      }

      tbody tr:hover {
        background-color: #edf2f7;
        transition: background-color 0.3s;
      }

      /* ===== Buttons & Icons ===== */
      .copy-btn {
        border: none;
        background: none;
        padding: 0;
        cursor: pointer;
        color: #3182ce;
        margin-left: 0.5rem;
        font-size: 1rem;
        transition: color 0.3s;
      }

      .copy-btn:hover {
        color: #2b6cb0;
      }

      /* ===== Pagination Styling ===== */
      .pagination {
        justify-content: center;
      }

      .page-link {
        color: #3182ce;
        transition: background-color 0.3s, color 0.3s;
      }

      .page-link:hover {
        background-color: #e2e8f0;
        color: #2c5282;
      }

      .page-item.active .page-link {
        background-color: #3182ce;
        border-color: #3182ce;
        color: #fff;
      }

      /* ===== Responsive Iframes ===== */
      iframe.table-iframe {
        border-radius: 8px;
        width: 100%;
        height: auto;
        max-width: 220px;
        aspect-ratio: 16 / 9; /* Maintain aspect ratio */
      }

      @media (max-width: 768px) {
        .filter-form {
          padding: 1.5rem;
        }

        header h1 {
          font-size: 2rem;
        }

        header p {
          font-size: 1rem;
        }

        iframe.table-iframe {
          width: 100% !important;
          height: auto !important;
        }

        th, td {
          white-space: normal;
        }
      }

      /* ===== No Results Styling ===== */
      .no-results {
        text-align: center;
        padding: 3rem 0;
        color: #718096;
      }

      .no-results i {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      /* ===== Resizable Columns ===== */
      th .resizer {
        position: absolute;
        right: 0;
        top: 0;
        width: 5px;
        cursor: col-resize;
        user-select: none;
        height: 100%;
      }

      .resizing {
        user-select: none;
      }

      /* ===== Footer Styling ===== */
      footer {
        text-align: center;
        padding: 1rem 0;
      }

      footer small {
        color: #6c757d;
        transition: color 0.3s;
      }

      /* ===== Smooth Scroll for Pagination ===== */
      html {
        scroll-behavior: smooth;
      }

      /* ===== Enhanced Input Focus Styling ===== */
      .form-control:focus,
      .form-select:focus {
        box-shadow: none;
        border-color: #3182ce;
      }

      /* ===== Modern Button Styling ===== */
      .btn-primary {
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .btn-outline-light {
        border-radius: 50px;
        padding: 0.5rem 1rem;
        transition: background-color 0.3s, color 0.3s;
      }

      .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
      }

      /* ===== Tooltip Styling ===== */
      .tooltip-inner {
        background-color: #333;
        color: #fff;
        border-radius: 4px;
        padding: 0.5rem;
        font-size: 0.875rem;
      }

      /* ===== Table Size Variants ===== */
      .table-size-small {
        font-size: 0.85rem;
      }
      .table-size-small table tbody tr td,
      .table-size-small table thead tr th {
        padding: 0.4rem 0.5rem;
      }

      .table-size-large {
        font-size: 1.1rem;
      }
      .table-size-large table tbody tr td,
      .table-size-large table thead tr th {
        padding: 1rem;
      }

      /* ===== Table Size Icons Container ===== */
      .table-size-icons {
        margin-bottom: 0.5rem;
      }
      .table-size-icons button {
        border: none;
        background: #fff;
        font-size: 1rem;
        cursor: pointer;
        margin-left: 0.25rem;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .table-size-icons button:focus {
        outline: none;
      }
      .table-size-icons button:hover {
        background-color: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-disc"></i> Discogs Vinyl Techno Releases 1994-2001
        </a>
      </div>
    </nav>

    <div class="container my-5">
      <!-- Filter/Search Form -->
      <form id="filter-form" class="filter-form">
        <div class="row g-4 align-items-end">
          <div class="col-md-2">
            <label for="search_query" class="form-label"
              >Search (Title/Label)</label
            >
            <input
              type="text"
              id="search_query"
              name="search_query"
              class="form-control"
              placeholder="e.g. Underground Resistance"
              aria-label="Search by Title or Label"
            />
          </div>
          <div class="col-md-2">
            <label for="genre" class="form-label">Genre</label>
            <select
              id="genre"
              name="genre"
              class="form-select"
              aria-label="Filter by Genre"
            >
              <option value="">All Genres</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="style" class="form-label">Style</label>
            <select
              id="style"
              name="style"
              class="form-select"
              aria-label="Filter by Style"
            >
              <option value="">All Styles</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="year_min" class="form-label">Year ≥</label>
            <input
              type="number"
              id="year_min"
              name="year_min"
              class="form-control"
              placeholder="e.g. 1995"
              aria-label="Minimum Year"
            />
          </div>
          <div class="col-md-2">
            <label for="year_max" class="form-label">Year ≤</label>
            <input
              type="number"
              id="year_max"
              name="year_max"
              class="form-control"
              placeholder="e.g. 2000"
              aria-label="Maximum Year"
            />
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-funnel-fill"></i> Filter
            </button>
          </div>
        </div>
      </form>

      <!-- Results Count -->
      <div id="results-count" class="mb-3 fw-semibold"></div>

      <!-- Table Size Icons (top-right) -->
      <div class="d-flex justify-content-end align-items-center table-size-icons">
        <span class="me-2 text-muted" style="font-size: 0.9rem;">Table Size:</span>
        <!-- Small icon -->
        <button id="table-size-small" title="Small Table">
          <i class="bi bi-zoom-out"></i>
        </button>
        <!-- Standard icon -->
        <button id="table-size-standard" title="Standard Table">
          <i class="bi bi-aspect-ratio"></i>
        </button>
        <!-- Large icon -->
        <button id="table-size-large" title="Large Table">
          <i class="bi bi-zoom-in"></i>
        </button>
      </div>

      <!-- Table Container -->
      <div class="table-container" id="table-size-container">
        <div class="table-responsive">
          <table class="table table-hover table-bordered mb-0" role="table">
            <thead>
              <tr>
                <!-- Updated Column Order: Title, Label, Year, Genre, User Rating, Rarity, Gem, Have, Want, Preview -->
                <th scope="col" data-column="Title">
                  Title
                  <div class="resizer"></div>
                </th>
                <th scope="col" data-column="Label">
                  Label
                  <div class="resizer"></div>
                </th>
                <th
                  scope="col"
                  class="text-center"
                  style="width: 80px"
                  data-sort="year"
                  data-column="Year"
                >
                  Year
                  <div class="resizer"></div>
                </th>
                <th scope="col" data-column="Genre / Style">
                  Genre / Style
                  <div class="resizer"></div>
                </th>
                <!-- User Rating with tooltip -->
                <th
                  scope="col"
                  class="text-center"
                  style="width: 150px"
                  data-sort="average_rating"
                  data-column="User Rating"
                  title="Click to sort. Cycles between: 
Highest Avg, Bayesian Average, Worst Rated."
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-delay='{"show":1000, "hide":100}'
                >
                  User Rating
                  <div class="resizer"></div>
                </th>
                <!-- Rarity with tooltip -->
                <th
                  scope="col"
                  class="text-center"
                  style="width: 100px"
                  data-sort="demand_coeff"
                  data-column="Rarity"
                  title="Click to sort by Rarity (want/have ratio). Higher means more in-demand and low supply."
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-delay='{"show":1000, "hide":100}'
                >
                  Rarity
                  <div class="resizer"></div>
                </th>
                <!-- Gem with tooltip -->
                <th
                  scope="col"
                  class="text-center"
                  style="width: 100px"
                  data-sort="gem_value"
                  data-column="Gem ⟡"
                  title="Click to sort by Gem (combined metric factoring rating and rarity)."
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-delay='{"show":1000, "hide":100}'
                >
                  Gem⟡
                  <div class="resizer"></div>
                </th>
                <th
                  scope="col"
                  class="text-center"
                  style="width: 70px"
                  data-sort="have"
                  data-column="Have"
                >
                  Have
                  <div class="resizer"></div>
                </th>
                <th
                  scope="col"
                  class="text-center"
                  style="width: 70px"
                  data-sort="want"
                  data-column="Want"
                >
                  Want
                  <div class="resizer"></div>
                </th>
                <th
                  scope="col"
                  class="text-center"
                  style="width: 220px"
                  data-column="Preview"
                >
                  Preview
                  <div class="resizer"></div>
                </th>
              </tr>
            </thead>
            <tbody id="releases-table-body">
              <!-- Rows will be populated dynamically -->
            </tbody>
          </table>
        </div>
        <!-- table-responsive -->
      </div>
      <!-- table-container -->

      <!-- Pagination Controls -->
      <nav class="mt-4" aria-label="Page navigation">
        <ul class="pagination" id="pagination">
          <!-- Pagination items will be populated dynamically -->
        </ul>
      </nav>
    </div>
    <!-- /.container -->

    <!-- Footer with Credit -->
    <footer>
      <small>&copy; Jannik Aßfalg</small>
    </footer>

    <!-- Bootstrap JS (with Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Embedded Data: Your NEW JSON -->
    <script>
      const releasesData = [
        {
          "average_rating": 5.0,
          "country": "Mexico",
          "demand_coeff": 0.75,
          "gem_value": 2.3863636363636362,
          "genre": "Electronic",
          "have": 3,
          "id": 1,
          "label": "RCA",
          "link": "https://www.discogs.com/release/16875240",
          "lowest_price": 14.33,
          "rating_coeff": 3.1818181818181817,
          "rating_count": 1,
          "style": "Techno",
          "title": "India (2) - India - Stay With Me (Special Remix) Disco-Tec Sencillo = Quédate Conmigo",
          "want": 3,
          "year": "1983",
          "youtube_links": "https://www.youtube.com/watch?v=96XKde8YHk8"
        }
      ];
    </script>

    <!-- JavaScript for Data Handling -->
    <script>
      // Default: Standard size => 10 per page
      let pageSize = 10;
      let filteredData = [];
      let currentPage = 1;
      let totalPages = 1;
      let genres = {};
      let styles = {};
      let sortConfig = {
        key: "average_rating",
        order: "desc",
        userRatingSortMode: 1, // 1: Bayesian Average by default
      };

      // Initialize filters and apply initial filters
      function initialize() {
        initializeFilters();
        applyFilters();
        applySavedColumnWidths();
        makeTableResizable();

        // Set up table-size icon events
        document.getElementById("table-size-small").addEventListener("click", () => {
          setTableSize("small");
        });
        document.getElementById("table-size-standard").addEventListener("click", () => {
          setTableSize("standard");
        });
        document.getElementById("table-size-large").addEventListener("click", () => {
          setTableSize("large");
        });

        // Initialize or re-initialize tooltips
        initTooltips();
      }

      // Programmatic tooltips init (ensures they hide properly on mouseout)
      function initTooltips() {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach((tooltipTriggerEl) => {
          // If there's an existing tooltip instance, dispose it first
          const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
          if (existingTooltip) {
            existingTooltip.dispose();
          }
          // Create a new tooltip with hover as the trigger
          new bootstrap.Tooltip(tooltipTriggerEl, {
            container: 'body',
            trigger: 'hover',
            boundary: 'viewport',
            delay: { show: 500, hide: 100 },
            placement: tooltipTriggerEl.getAttribute("data-bs-placement") || 'top'
          });
        });
      }

      // Set the table size (visual + how many results per page)
      function setTableSize(sizeOption) {
        const container = document.getElementById("table-size-container");

        // Remove any size-related classes first
        container.classList.remove("table-size-small", "table-size-large");

        switch (sizeOption) {
          case "small":
            pageSize = 50;
            container.classList.add("table-size-small");
            break;
          case "large":
            pageSize = 5;
            container.classList.add("table-size-large");
            break;
          default:
            // standard
            pageSize = 10;
            break;
        }

        // Reset to first page and redraw table/pagination
        currentPage = 1;
        renderTable();
        renderPagination();
      }

      // Initialize filter options
      function initializeFilters() {
        releasesData.forEach((release) => {
          // Populate genres
          if (release.genre) {
            release.genre.split(",").forEach((g) => {
              g = g.trim();
              if (g) genres[g] = (genres[g] || 0) + 1;
            });
          }
          // Populate styles
          if (release.style) {
            release.style.split(",").forEach((s) => {
              s = s.trim();
              if (s) styles[s] = (styles[s] || 0) + 1;
            });
          }
        });

        // Populate genre dropdown
        const genreSelect = document.getElementById("genre");
        const sortedGenres = Object.entries(genres).sort((a, b) =>
          a[0].localeCompare(b[0])
        );
        sortedGenres.forEach(([genre, count]) => {
          const option = document.createElement("option");
          option.value = genre;
          option.textContent = `${genre} (${count})`;
          genreSelect.appendChild(option);
        });

        // Populate style dropdown
        const styleSelect = document.getElementById("style");
        const sortedStyles = Object.entries(styles).sort((a, b) =>
          a[0].localeCompare(b[0])
        );
        sortedStyles.forEach(([style, count]) => {
          const option = document.createElement("option");
          option.value = style;
          option.textContent = `${style} (${count})`;
          styleSelect.appendChild(option);
        });
      }

      // Apply filters based on user input
      function applyFilters() {
        const searchQuery = document
          .getElementById("search_query")
          .value.trim()
          .toLowerCase();
        const selectedGenre = document.getElementById("genre").value;
        const selectedStyle = document.getElementById("style").value;
        const yearMin =
          parseInt(document.getElementById("year_min").value) || -Infinity;
        const yearMax =
          parseInt(document.getElementById("year_max").value) || Infinity;

        filteredData = releasesData.filter((release) => {
          // Label check
          const releaseLabel = release.label ? release.label.toLowerCase() : "";

          const matchesSearch =
            !searchQuery ||
            (release.title &&
              release.title.toLowerCase().includes(searchQuery)) ||
            (releaseLabel && releaseLabel.includes(searchQuery));

          const matchesGenre =
            !selectedGenre ||
            (release.genre &&
              release.genre
                .split(",")
                .map((g) => g.trim())
                .includes(selectedGenre));

          const matchesStyle =
            !selectedStyle ||
            (release.style &&
              release.style
                .split(",")
                .map((s) => s.trim())
                .includes(selectedStyle));

          const matchesYear =
            parseInt(release.year) >= yearMin &&
            parseInt(release.year) <= yearMax;

          return matchesSearch && matchesGenre && matchesStyle && matchesYear;
        });

        sortData();
        currentPage = 1;
        totalPages = Math.ceil(filteredData.length / pageSize) || 1;
        renderTable();
        renderPagination();
      }

      // Calculate Bayesian Average
      function calculateBayesianAverage(release, m = 3, C = 10) {
        const R = parseFloat(release.average_rating) || 0;
        const v = parseInt(release.rating_count) || 0;
        return (C * m + R * v) / (C + v);
      }

      // Sort data based on sortConfig
      function sortData() {
        const { key, order, userRatingSortMode } = sortConfig;
        if (key === "average_rating") {
          // Special handling for user rating sorting
          if (userRatingSortMode === 0) {
            // 0: Highest Average & Most Votes
            filteredData.sort((a, b) => {
              const aRating = parseFloat(a.average_rating) || 0;
              const bRating = parseFloat(b.average_rating) || 0;
              const aVotes = parseInt(a.rating_count) || 0;
              const bVotes = parseInt(b.rating_count) || 0;

              if (bRating !== aRating) {
                return bRating - aRating;
              }
              return bVotes - aVotes;
            });
          } else if (userRatingSortMode === 1) {
            // 1: Bayesian Average
            filteredData.sort((a, b) => {
              const aBayesian = calculateBayesianAverage(a);
              const bBayesian = calculateBayesianAverage(b);
              return bBayesian - aBayesian;
            });
          } else if (userRatingSortMode === 2) {
            // 2: Worst Rated
            filteredData.sort((a, b) => {
              const aRating = parseFloat(a.average_rating) || 0;
              const bRating = parseFloat(b.average_rating) || 0;
              const aVotes = parseInt(a.rating_count) || 0;
              const bVotes = parseInt(b.rating_count) || 0;

              if (aRating !== bRating) {
                return aRating - bRating;
              }
              return bVotes - aVotes;
            });
          }
        } else {
          // Sorting for other columns
          filteredData.sort((a, b) => {
            let aValue, bValue;

            if (key === "Title") {
              aValue = a.title || "";
              bValue = b.title || "";
            } else if (key === "Label") {
              aValue = a.label || "";
              bValue = b.label || "";
            } else if (key === "Year") {
              aValue = parseInt(a.year) || 0;
              bValue = parseInt(b.year) || 0;
            } else if (key === "Genre / Style") {
              // We'll sort by genre + style strings combined, if needed
              aValue = `${a.genre || ""} ${a.style || ""}`;
              bValue = `${b.genre || ""} ${b.style || ""}`;
            } else if (
              key === "demand_coeff" ||
              key === "gem_value" ||
              key === "have" ||
              key === "want"
            ) {
              aValue = parseFloat(a[key]) || 0;
              bValue = parseFloat(b[key]) || 0;
            } else {
              aValue = a[key] || "";
              bValue = b[key] || "";
            }

            // Numerical sorting
            if (
              key === "Year" ||
              key === "demand_coeff" ||
              key === "gem_value" ||
              key === "have" ||
              key === "want"
            ) {
              if (aValue < bValue) return order === "asc" ? -1 : 1;
              if (aValue > bValue) return order === "asc" ? 1 : -1;
              return 0;
            }

            // String sorting
            aValue = aValue.toString().toLowerCase();
            bValue = bValue.toString().toLowerCase();
            if (aValue < bValue) return order === "asc" ? -1 : 1;
            if (aValue > bValue) return order === "asc" ? 1 : -1;
            return 0;
          });
        }
      }

      // Generate star rating HTML
      function generateStars(average_rating) {
        const fullStars = Math.floor(average_rating);
        const halfStar = average_rating % 1 >= 0.5 ? 1 : 0;
        const emptyStars = 5 - fullStars - halfStar;
        let starsHtml = "";
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
        }
        if (halfStar) {
          starsHtml += '<i class="bi bi-star-half text-warning"></i>';
        }
        for (let i = 0; i < emptyStars; i++) {
          starsHtml += '<i class="bi bi-star text-warning"></i>';
        }
        return starsHtml;
      }

      // Render the releases table
      function renderTable() {
        const tbody = document.getElementById("releases-table-body");
        tbody.innerHTML = "";

        // Update results count display
        document.getElementById("results-count").textContent =
          `Showing ${filteredData.length} result(s)`;

        if (filteredData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="10" class="no-results">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <p>No results found.</p>
              </td>
            </tr>
          `;
          return;
        }

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = filteredData.slice(start, end);

        pageData.forEach((release) => {
          const tr = document.createElement("tr");

          // Title + Copy button
          const tdTitle = document.createElement("td");
          const titleDiv = document.createElement("div");
          titleDiv.className = "d-flex align-items-center";

          const titleLink = document.createElement("a");
          titleLink.href = release.link;
          titleLink.target = "_blank";
          titleLink.rel = "noopener noreferrer";
          titleLink.className = "text-decoration-none text-primary fw-semibold";
          titleLink.textContent = release.title;

          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn btn btn-link";
          copyBtn.setAttribute("data-title", release.title);
          copyBtn.title = "Copy Title";
          copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';

          titleDiv.appendChild(titleLink);
          titleDiv.appendChild(copyBtn);
          tdTitle.appendChild(titleDiv);
          tr.appendChild(tdTitle);

          // Label
          const tdLabel = document.createElement("td");
          tdLabel.textContent = release.label ? release.label : "Unknown";
          tr.appendChild(tdLabel);

          // Year
          const tdYear = document.createElement("td");
          tdYear.className = "text-center";
          tdYear.textContent = release.year;
          tr.appendChild(tdYear);

          // Genre / Style
          const tdGenreStyle = document.createElement("td");

          // Genre as a separate badge
          const genreTag = release.genre
            ? `<span class="badge bg-primary me-1">${release.genre}</span>`
            : `<span class="badge bg-secondary me-1">Unknown</span>`;

          // Styles as multiple badges
          const styleList = release.style
            ? release.style.split(",").map((s) => s.trim())
            : [];
          const styleTags = styleList
            .map((s) => `<span class="badge bg-info me-1">${s}</span>`)
            .join("");

          tdGenreStyle.innerHTML = genreTag + styleTags;
          tr.appendChild(tdGenreStyle);

          // User Rating (Stars + Count)
          const tdUserRating = document.createElement("td");
          tdUserRating.className = "text-center";
          if (
            release.average_rating !== undefined &&
            release.rating_count !== undefined
          ) {
            tdUserRating.innerHTML = `${generateStars(
              release.average_rating
            )} (${release.rating_count})`;
          } else {
            tdUserRating.innerHTML = '<div class="text-muted">No rating</div>';
          }
          tr.appendChild(tdUserRating);

          // Rarity
          const tdRarity = document.createElement("td");
          tdRarity.className = "text-center";
          tdRarity.textContent = release.demand_coeff
            ? release.demand_coeff.toFixed(2)
            : "0.00";
          tr.appendChild(tdRarity);

          // Gem
          const tdGem = document.createElement("td");
          tdGem.className = "text-center";
          tdGem.textContent = release.gem_value
            ? release.gem_value.toFixed(2)
            : "0.00";
          tr.appendChild(tdGem);

          // Have
          const tdHave = document.createElement("td");
          tdHave.className = "text-center";
          tdHave.textContent = release.have;
          tr.appendChild(tdHave);

          // Want
          const tdWant = document.createElement("td");
          tdWant.className = "text-center";
          tdWant.textContent = release.want;
          tr.appendChild(tdWant);

          // Preview (YouTube embed)
          const tdPreview = document.createElement("td");
          tdPreview.className = "text-center";
          tdPreview.style.overflow = "hidden";

          if (release.youtube_links) {
            const links = release.youtube_links
              .split(",")
              .map((l) => l.trim())
              .filter((l) => l);
            if (links.length > 0) {
              const firstLink = links[0];
              const youtubeID = extractYouTubeID(firstLink);
              if (youtubeID) {
                const iframe = document.createElement("iframe");
                iframe.className = "table-iframe";
                iframe.loading = "lazy";
                iframe.title = "YouTube video player";
                iframe.setAttribute("aria-label", "YouTube video player");
                iframe.src = `https://www.youtube.com/embed/${youtubeID}?rel=0&modestbranding=1`;
                iframe.frameBorder = "0";
                iframe.allowFullscreen = true;
                tdPreview.appendChild(iframe);
              } else {
                tdPreview.innerHTML =
                  '<div class="text-muted">Invalid YouTube link</div>';
              }
            } else {
              tdPreview.innerHTML =
                '<div class="text-muted">No YouTube links</div>';
            }
          } else {
            tdPreview.innerHTML = '<div class="text-muted">No YouTube links</div>';
          }

          tr.appendChild(tdPreview);
          tbody.appendChild(tr);
        });

        // Attach copy functionality
        attachCopyHandlers();
      }

      // Extract YouTube ID from a URL
      function extractYouTubeID(url) {
        const regex =
          /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?/\s]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
      }

      // Attach copy-to-clipboard handlers
      function attachCopyHandlers() {
        const copyButtons = document.querySelectorAll(".copy-btn");
        copyButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const title = button.getAttribute("data-title");
            if (title) {
              navigator.clipboard
                .writeText(title)
                .then(() => {
                  const originalTitle = button.getAttribute("title");
                  button.setAttribute("title", "Copied!");
                  const tooltip = new bootstrap.Tooltip(button, {
                    container: 'body',
                    trigger: 'manual'
                  });
                  tooltip.show();

                  setTimeout(() => {
                    button.setAttribute("title", originalTitle);
                    tooltip.hide();
                    tooltip.dispose();
                  }, 2000);
                })
                .catch((err) => {
                  console.error("Could not copy text: ", err);
                });
            }
          });
        });
      }

      // Render pagination controls
      function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        totalPages = Math.ceil(filteredData.length / pageSize) || 1;
        if (totalPages <= 1) return;

        // Previous button
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        const prevLink = document.createElement("a");
        prevLink.className = "page-link";
        prevLink.href = "#";
        prevLink.innerHTML = `<i class="bi bi-chevron-left"></i> Prev`;
        prevLink.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderTable();
            renderPagination();
            window.scrollTo(0, 0);
          }
        });
        prevLi.appendChild(prevLink);
        pagination.appendChild(prevLi);

        // Page numbers
        for (let p = 1; p <= totalPages; p++) {
          if (
            p === 1 ||
            p === totalPages ||
            (p >= currentPage - 2 && p <= currentPage + 2)
          ) {
            const pageLi = document.createElement("li");
            pageLi.className = `page-item ${p === currentPage ? "active" : ""}`;
            const pageLink = document.createElement("a");
            pageLink.className = "page-link";
            pageLink.href = "#";
            pageLink.textContent = p;
            pageLink.addEventListener("click", (e) => {
              e.preventDefault();
              currentPage = p;
              renderTable();
              renderPagination();
              window.scrollTo(0, 0);
            });
            pageLi.appendChild(pageLink);
            pagination.appendChild(pageLi);
          } else if (p === currentPage - 3 || p === currentPage + 3) {
            const ellipsisLi = document.createElement("li");
            ellipsisLi.className = "page-item disabled";
            const ellipsisSpan = document.createElement("span");
            ellipsisSpan.className = "page-link";
            ellipsisSpan.textContent = "...";
            ellipsisLi.appendChild(ellipsisSpan);
            pagination.appendChild(ellipsisLi);
          }
        }

        // Next button
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${
          currentPage === totalPages ? "disabled" : ""
        }`;
        const nextLink = document.createElement("a");
        nextLink.className = "page-link";
        nextLink.href = "#";
        nextLink.innerHTML = `Next <i class="bi bi-chevron-right"></i>`;
        nextLink.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            renderTable();
            renderPagination();
            window.scrollTo(0, 0);
          }
        });
        nextLi.appendChild(nextLink);
        pagination.appendChild(nextLi);
      }

      // Handle form submission
      document.getElementById("filter-form").addEventListener("submit", (e) => {
        e.preventDefault();
        applyFilters();
      });

      // Add click event listeners to sortable headers
      document.querySelectorAll("th[data-sort]").forEach((header) => {
        header.addEventListener("click", () => {
          const column = header.getAttribute("data-column");
          if (column === "User Rating") {
            // Cycle through sort modes for user rating:
            // 0 - Highest Avg & Most Votes, 1 - Bayesian, 2 - Worst Rated
            sortConfig.userRatingSortMode = (sortConfig.userRatingSortMode + 1) % 3;
            if (sortConfig.userRatingSortMode === 0) {
              sortConfig.key = "average_rating";
              sortConfig.order = "desc";
            } else if (sortConfig.userRatingSortMode === 1) {
              sortConfig.key = "average_rating";
              sortConfig.order = "desc";
            } else if (sortConfig.userRatingSortMode === 2) {
              sortConfig.key = "average_rating";
              sortConfig.order = "asc";
            }
          } else {
            const sortKey = header.getAttribute("data-sort");
            if (sortConfig.key === sortKey) {
              sortConfig.order = sortConfig.order === "asc" ? "desc" : "asc";
            } else {
              sortConfig.key = sortKey;
              sortConfig.order = "asc";
            }
            // Reset User Rating sort mode if not sorting by that column
            if (column !== "User Rating") {
              sortConfig.userRatingSortMode = 0;
            }
          }
          sortData();
          renderTable();
          renderPagination();
          updateSortIndicators();
          // Re-init tooltips so the newly updated headers get fresh tooltips
          initTooltips();
        });
      });

      // Update sort indicators (arrows/icons)
      function updateSortIndicators() {
        document.querySelectorAll("th[data-sort]").forEach((header) => {
          const column = header.getAttribute("data-column");
          const sortKey = header.getAttribute("data-sort");
          // Store existing tooltip attributes
          const existingTitle = header.getAttribute("title");
          const existingDataToggle = header.getAttribute("data-bs-toggle");
          const existingDataPlacement = header.getAttribute("data-bs-placement");
          const existingDataDelay = header.getAttribute("data-bs-delay");

          // Reset to original column text
          header.innerHTML = `${column}`;

          // Reapply tooltip attributes
          if (existingTitle) {
            header.setAttribute("title", existingTitle);
          }
          if (existingDataToggle) {
            header.setAttribute("data-bs-toggle", existingDataToggle);
          }
          if (existingDataPlacement) {
            header.setAttribute("data-bs-placement", existingDataPlacement);
          }
          if (existingDataDelay) {
            header.setAttribute("data-bs-delay", existingDataDelay);
          }

          // Add relevant sort indicator
          if (column === "User Rating") {
            if (sortConfig.userRatingSortMode === 0) {
              header.innerHTML +=
                '<i class="bi bi-arrow-up sort-indicator" title="Highest Average & Most Votes"></i>';
            } else if (sortConfig.userRatingSortMode === 1) {
              header.innerHTML +=
                '<i class="bi bi-bar-chart sort-indicator" title="Bayesian Average"></i>';
            } else if (sortConfig.userRatingSortMode === 2) {
              header.innerHTML +=
                '<i class="bi bi-arrow-down sort-indicator" title="Worst Rated"></i>';
            }
          } else {
            if (sortKey === sortConfig.key) {
              const indicator =
                sortConfig.order === "asc"
                  ? '<i class="bi bi-arrow-up sort-indicator"></i>'
                  : '<i class="bi bi-arrow-down sort-indicator"></i>';
              header.innerHTML += indicator;
            }
          }

          // Re-append the resizer
          const resizer = document.createElement("div");
          resizer.className = "resizer";
          header.appendChild(resizer);
        });
      }

      // Apply saved column widths from localStorage
      function applySavedColumnWidths() {
        const savedWidths = JSON.parse(localStorage.getItem("tableColumnWidths"));
        if (savedWidths) {
          const thElements = document.querySelectorAll("th[data-column]");
          thElements.forEach((th) => {
            const column = th.getAttribute("data-column");
            if (savedWidths[column]) {
              th.style.width = savedWidths[column] + "px";
            }
          });
        }
      }

      // Save current column widths to localStorage
      function saveColumnWidths() {
        const thElements = document.querySelectorAll("th[data-column]");
        const widths = {};
        thElements.forEach((th) => {
          const column = th.getAttribute("data-column");
          widths[column] = th.offsetWidth;
        });
        localStorage.setItem("tableColumnWidths", JSON.stringify(widths));
      }

      // Make table columns resizable
      function makeTableResizable() {
        const thElements = document.querySelectorAll("th[data-column]");
        thElements.forEach((th) => {
          const resizer = th.querySelector(".resizer");
          if (!resizer) return;

          let startX, startWidth;

          resizer.addEventListener("mousedown", (e) => {
            e.preventDefault();
            startX = e.pageX;
            startWidth = th.offsetWidth;
            document.body.classList.add("resizing");

            const onMouseMove = (e) => {
              const dx = e.pageX - startX;
              const newWidth = startWidth + dx;
              if (newWidth > 50) {
                th.style.width = newWidth + "px";
              }
            };

            const onMouseUp = () => {
              document.body.classList.remove("resizing");
              saveColumnWidths();
              document.removeEventListener("mousemove", onMouseMove);
              document.removeEventListener("mouseup", onMouseUp);
            };

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
          });
        });
      }

      // Initial setup
      updateSortIndicators();
      initialize();
    </script>
  </body>
</html>